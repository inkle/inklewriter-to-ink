<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>inklewriter to ink converter</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- <link rel="stylesheet" href="style.css"> -->

</head>

<body>

    <style>
    .hidden {
        display: none;
    }
    </style>

    <h1>inklewriter JSON to ink converter</h1>

    <input type="file" id="file" name="inklewriter JSON file" />

    <div id="converted_ink" class="hidden">
        <h3 id="converted_ink_title"></h3> 

        <button id="download_button" onclick='download()'>Download</button>

        <pre id="result_ink"></pre>
    </div>

    
    </pre>

    <!-- Hack to allow easy reuse of the node-based JS file! -->
    <script>let exports = {}</script>
    <script src="dist/inklewriter-convert.js"></script>


    <script>
        
        let currentFilename = "";
        let convertedInk = "";
        let convertedInkFilename = "";

        function handleFileSelect(evt) {
            let files = evt.target.files; // FileList object
            if( !files || files.length <= 0 )
                return;

            let file = files[0];
            var reader = new FileReader();

            currentFilename = file.name;

            reader.onload = function(theFile) {
                console.log(reader.result);

                let resultTxt = "";
                try {
                    let loadedJSON = JSON.parse(reader.result);
                    resultTxt = convertedInk = convert(loadedJSON);
                } catch(e) {
                    resultTxt = e.toString();
                }

                convertedInkFilename = currentFilename.replace(".json", ".ink");
                if( convertedInkFilename.indexOf(".ink") == -1 ) convertedInkFilename += ".ink";

                document.getElementById('result_ink').innerText = resultTxt;
                document.getElementById('converted_ink').classList.remove("hidden");
                document.getElementById('converted_ink_title').innerText = convertedInkFilename;
                document.getElementById('download_button').innerText = "Download "+convertedInkFilename;
            };

            // Read in the image file as a data URL.
            reader.readAsText(file);
        }

        document.getElementById('file').addEventListener('change', handleFileSelect, false);

        function download() {
            download_file(convertedInkFilename, convertedInk);
        }

        // Yay, stackoverflow coding!
        // https://stackoverflow.com/questions/8310657/how-to-create-a-dynamic-file-link-for-download-in-javascript
        function download_file(name, contents, mime_type) {
            mime_type = mime_type || "text/plain";

            var blob = new Blob([contents], {type: mime_type});

            var dlink = document.createElement('a');
            dlink.download = name;
            dlink.href = window.URL.createObjectURL(blob);
            dlink.onclick = function(e) {
                // revokeObjectURL needs a delay to work properly
                var that = this;
                setTimeout(function() {
                    window.URL.revokeObjectURL(that.href);
                }, 1500);
            };

            dlink.click();
            dlink.remove();
        }
    </script>

</body>
</html>